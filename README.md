<div align="center">

<!-- logo coming soon...
![img](assets/img/Ant_v4.png)
-->

[![License: GPLv3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0) [![CI](https://github.com/herzik-lab/ANTIDOTE/actions/workflows/ci.yml/badge.svg)](https://github.com/herzik-lab/ANTIDOTE/actions/workflows/ci.yml) [![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

</div>

# Table of Contents

- [Table of Contents](#table-of-contents)
- [Installation](#installation)
- [Quick Start](#quick-start)
- [Inference](#inference)
- [Tools](#tools)
  - [Adjusting the cutoff threshold](#adjusting-the-cutoff-threshold)
  - [Working with data from CryoSPARC](#working-with-data-from-cryosparc)
    - [Extracting particles from CryoSPARC job data](#extracting-particles-from-cryosparc-job-data)
    - [Re-importing particles into CryoSPARC](#re-importing-particles-into-cryosparc)
    - [Note on y-axis inversion](#note-on-y-axis-inversion)
  - [Additional tools and options](#additional-tools-and-options)
- [Training](#training)
- [Developing / Contributing](#developing--contributing)

# Installation

ANTIDOTE can be installed from a local repository with [conda](https://docs.anaconda.com/anaconda/install/) and pip. The recommended installation approach is:

```console
# clone ANTIDOTE from GitHub
git clone https://github.com/herzik-lab/ANTIDOTE.git
cd ANTIDOTE/

# create and activate a clean conda env
conda create --name antidote -c conda-forge python=3.11 pytables pyem
conda activate antidote

# install ANTIDOTE
pip install .
```

# Quick Start

ANTIDOTE uses a command based system:

- `antidote inference` for processing a 3D Classification dataset using a pre-trained model. This will be the most common way that users interact with ANTIDOTE.
- `antidote tools` for preparing ANTIDOTE input or processing ANTIDOTE output. This is effectively a catch-all for tools provided alongside ANTIDOTE.
- `antidote train` for training or fine-tuning an ANTIDOTE model using labeled 3D Classification data. This will be exposed and available to users but likely not a typical use case.

To use ANTIDOTE to curate particles, install ANTIDOTE, activate the conda environment, and pass the output of a RELION 3D Classification job to `antidote inference`:

```
(antidote) $ antidote inference --input /path/to/relion/Class3D/my_job --output ./my_job_output
```

For example, with the provided test data (running from the root of the repository):

```
(antidote) $ antidote inference --input ./tests/data/minimal_job/ --output ./tests/data/minimal_job_output/
```

ANTIDOTE will generate 4 files ([an example](https://github.com/herzik-lab/ANTIDOTE/tree/main/examples/minimal_job_output)):

- `./my_job_output/true_predictions.star`: A starfile containing the particles chosen by ANTIDOTE. This file can be used for further processing in RELION or importing particles into CryoSPARC.
- `./my_job_output/full_predictions.star`: A starfile containing all of the input particles with their ANTIDOTE labels. This file can be used to adjust the cutoff threshold using the `split-starfile` tool included in ANTIDOTE.
- `./my_job_output/antidote_summary_report.html`: An HTML report containing information about inference. This can be opened with a browser. A sample report can be found [here](https://herzik-lab.github.io/ANTIDOTE/antidote_summary_report.html).
- `./my_job_output/antidote_full_report.html`: An HTML report containing more detailed information about inference, including input data distribution plots (RELION 3D Classification metadata), which takes longer to generate and a bit longer to load in a browser. A sample report can be found [here](https://herzik-lab.github.io/ANTIDOTE/antidote_full_report.html).

In addition to the inference command, ANTIDOTE ships with a few tools that facilitate its use. See the [Tools](#tools) section for more in-depth explanation.

The distribution of labels generated by ANTIDOTE can be seen in an interactive histogram in the ANTIDOTE report (`./my_job_output/antidote_summary_report.html`). If desired, to adjust the output of ANTIDOTE in order to increase or decrease the threshold (to better fit the particle distribution), use the `split-starfile` tool. The default threshold is 0.5, but it can be adjusted. For example, to adjust to 0.7:

```
(antidote) $ antidote tools split-starfile -t 0.7 -i ./my_job_output/full_predictions.star
```

This will generate two additional starfiles with all of the particles above and below the new threshold of 0.7. See more at [Adjusting the cutoff threshold](#adjusting-the-cutoff-threshold).

To use particles from a CryoSPARC job in ANTIDOTE, you will have to run a RELION 3D Classification run to generate the input data for ANTIDOTE. We provide a convenient wrapper to Daniel Arsanow's csparc2star tool provided in [pyem](https://github.com/asarnow/pyem). It can be run in one line from the command line using the path to the CryoSPARC job:

```
(antidote) $ antidote tools convert-cryosparc -i /path/to/cryosparc/job/JXXX/ -o /path/to/relion/
```

See more at [Working with CryoSPARC job data](#working-with-cryosparc-job-data).

# Inference

For most use cases, ANTIDOTE will be used to classify particles using metadata from 3D Classification in RELION. To prepare a dataset for classification with ANTIDOTE, run a reference-free 3D Classification using RELION. The standard output generated by RELION is the input for ANTIDOTE. For example, for a 2-class classification, the output generally looks something like this:

```bash
$ tree /path/to/relion/Class3D/my_job
my_job
|-- RELION_JOB_EXIT_SUCCESS
|-- default_pipeline.star
|-- job.star
|-- job_pipeline.star
|-- note.txt
|-- run.out
|-- run_it000_class001.mrc
|-- run_it000_class001_angdist.bild
|-- run_it000_class002.mrc
|-- run_it000_class002_angdist.bild
|-- run_it000_data.star
|-- run_it000_model.star
|-- run_it000_optimiser.star
|-- run_it000_sampling.star
.
.
.
|-- run_it025_class001.mrc
|-- run_it025_class001_angdist.bild
|-- run_it025_class002.mrc
|-- run_it025_class002_angdist.bild
|-- run_it025_data.star
|-- run_it025_model.star
|-- run_it025_optimiser.star
|-- run_it025_sampling.star
`-- run_submit.script
```

To run inference with ANTIDOTE, pass this directory to ANTIDOTE:

```
(antidote) $ antidote inference --input /path/to/relion/Class3D/my_job --output ./my_job_output
```

ANTIDOTE takes RELION starfiles as input and generates a starfile containing the same particles as its output. By default, ANTIDOTE writes its per-particle prediction score (0 being a deleterious particle and 1 being a true particle) to the `rlnHelicalTrackLength` field of the output starfile (to facilitate the use of subset selection in RELION). If the `rlnHelicalTrackLength` field already exists, the inference command will fail. To fix this, a user can write the prediction score to a different field, by using the `--antidote-label-field-name` field flag with the desired field name. For example, to write the prediction score to a filed named `AntidotePrediction`:

```
(antidote) $ antidote inference --input /path/to/relion/Class3D/my_job --output ./my_job_output --antidote-label-field-name AntidotePrediction
```

In addition to starfiles with input particles and their corresponding ANTIDOTE labels, ANTIDOTE generates an HTML report containing information about the 3-D classification and a histogram of the ANTIDOTE predictions. To turn off the generation of the HTML report, use the `--no-report` flag.

Additional options for inference can be found in the help dialog:

```
(antidote) $ antidote inference --help
```

# Tools

## Adjusting the cutoff threshold

ANTIDOTE uses a threshold of 0.5 by default, and generates a starfile that only contains particles that are scored above that threshold alongside the full starfile with all predictions. If a used wants to manually adjust the threshold (perhaps after viewing the prediction histogram in the HTML report), the `split-starfile` tool can be used. The tool takes a starfile as input, along with a new threshold specified by the `-t` argument, and generates two new starfiles: one containing particles with a score above the threshold and one containing particles with a score below the threshold. For example, to adjust the threshold to 0.7:

```
(antidote) $ antidote tools split-starfile -t 0.7 -i /path/to/full_predictions.star
```

By default, it will split the input starfile by the `rlnHelicalTrackLength` field. To split by a different field, use the `--antidote-label-field-name` flag with the desired field name.

## Working with data from CryoSPARC

### Extracting particles from CryoSPARC job data

ANTIDOTE operates on metadata from 3-D classification in RELION. If a user wants to apply ANTIDOTE to their particle stack in CryoSPARC, they must first convert the CryoSPARC job data to a format that can be used to run RELION 3-D classification, which then can be used as input to ANTIDOTE. For convenience, we provide a command in `antidote tools` to orchestrate this. CryoSPARC conversion is handled by [pyem](https://github.com/asarnow/pyem) Supported CryoSPARC jobs are Select 2D, Extract from Micrographs, Ab-Initio (Beta), and NU-Refine (Non-Uniform Refinement). Note that for Ab-Initio, all particles are included for the 3-D classification input data, regardless of the particle being used, not used, or class.


```
(antidote) $ antidote tools convert-cryosparc --input /path/to/cryosparc/job/JXXX/ --output /path/to/relion/project_dir/
```

The `/path/to/relion/project_dir/` folder should be the RELION project directory (where the `relion` command is typically run). A star file will be generated in the user-provided RELION project directory (`JXXX.star`) and micrograph (`.mrcs` / `.mrc`) files will be symlinked to the RELION project directory, which can be used as input to RELION 3-D classification. The user can then run RELION 3-D classification on the converted data and then take the output from RELION 3D Classification and run inference with ANTIDOTE.

### Re-importing particles into CryoSPARC

After using the `convert-cryosparc` tool and running inference with ANTIDOTE on RELION 3D Classification output data, the user may want to re-import the particles back into CryoSPARC. To do this, the user can create an `Import Particles` job in CryoSPARC and use the `true_predictions.star` file created by ANTIDOTE as the `Particle meta path` input to the `Import Particles` job. The `Particle data path` input should be the path to the RELION project directory (`/path/to/relion/` in the example above).

### Note on y-axis inversion

The `convert-cryosparc` tool inverts the particle coordinate y-axis by default (by calling the csparc2star.py flag `--inverty`) to correct for CryoSPARC's y-axis inversion. The default parameters for the `antidote tools convert-cryosparc` command should make particle data from CryoSPARC compatible with RELION. The y-axis inversion can be turned off with the `--no-inverty` argument:

```
(antidote) $ antidote tools convert-cryosparc --no-inverty --input /path/to/cryosparc/job/JXXX/ --output /path/to/relion/project_dir/
```

## Additional tools and options

Additional options for tools can be found in the help dialog:

```
(antidote) $ antidote tools --help
(antidote) $ # or
(antidote) $ antidote tools <tool-name> --help
```

# Training

While we do not expect re-training ANTIDOTE models to be a common use-case, the training pipeline is included in ANTIDOTE and is fairly straightforward to use. Briefly, you will need a collection of labeled 3-D Classification datasets for training. For poisoning, we generate the `True` and `False` particle sets independently and mix them prior to 3D Classification. A string or other unique identifier should be present in the `rlnImageName` field of the starfiles generated by 3D Classification. Then, create a YAML file with the following structure:

```yaml
jobs:

    /path/to/class3D/job1/:
      - label: true_label

    /path/to/class3D/job2/:
      - label: true_label
```

More options for the input YAML file can be found in the [example file](https://github.com/herzik-lab/ANTIDOTE/blob/main/examples/example_training_config.yaml) in `./examples/`.

A series of ANTIDOTE models can be trained directly from the YAML file using the `train` command, which will spawn a hyperparameter search and continue to train the model with the highest score after hyperparameter evaluation:

```
(antidote) $ antidote train --from-yaml /path/to/yaml
```

Additional options for training can be found in the help dialog:

```
(antidote) $ antidote train --help
```

# Developing / Contributing

If you plan to modify or develop ANTIDOTE, install ANTIDOTE with pip as an editable module. This will allow you to make changes to the ANTIDOTE codebase without needing to reinstall the module:

```console
# install antidote
pip install -e .

# configure pre-commit hooks
pip install pre-commit
pre-commit install
```

To run e2e and unit tests to ensure that your changes do not break existing functionality, `pytest` can be run from the root of the repository. To enable verbose output and parallel testing, `pytest -n auto -vvv -s` can be used.
